name: ECR Mirror Approval Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

jobs:
  check-approval:
    # Only run for PRs with [DEVOPS-1094] in title
    if: |
      (github.event_name == 'pull_request' && startsWith(github.event.pull_request.title, '[DEVOPS-1094]')) ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && startsWith(github.event.issue.title, '[DEVOPS-1094]')) ||
      (github.event_name == 'pull_request_review' && startsWith(github.event.pull_request.title, '[DEVOPS-1094]'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      statuses: write
      checks: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get PR number
        id: pr-number
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "pull_request_review" ]]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Check for approvals
        id: check-approvals
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUM="${{ steps.pr-number.outputs.number }}"
          REPO="${{ github.repository }}"

          echo "Checking PR #$PR_NUM for approvals..."

          # Get PR reviews with APPROVED state
          APPROVED_COUNT=$(gh api "/repos/$REPO/pulls/$PR_NUM/reviews" --jq '[.[] | select(.state == "APPROVED")] | length')

          echo "Found $APPROVED_COUNT approved reviews"

          if [[ $APPROVED_COUNT -ge 1 ]]; then
            echo "approved=true" >> $GITHUB_OUTPUT
            echo "âœ… PR has required approvals"
          else
            echo "approved=false" >> $GITHUB_OUTPUT
            echo "âŒ PR needs at least 1 approval review"
          fi

      - name: Check if mirroring confirmation already posted
        if: steps.check-approvals.outputs.approved == 'true'
        id: check-confirmation
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUM="${{ steps.pr-number.outputs.number }}"

          # Check if we already posted the mirroring confirmation
          EXISTING_COMMENT=$(gh pr view $PR_NUM --json comments --jq '.comments[] | select(.body | contains("âœ… ECR Mirroring Complete")) | .id' || echo "")

          if [[ -n "$EXISTING_COMMENT" ]]; then
            echo "already_posted=true" >> $GITHUB_OUTPUT
            echo "Confirmation already posted"
          else
            echo "already_posted=false" >> $GITHUB_OUTPUT
            echo "No confirmation posted yet"
          fi

      - name: Download images artifact
        if: steps.check-approvals.outputs.approved == 'true' && steps.check-confirmation.outputs.already_posted == 'false'
        uses: actions/download-artifact@v4
        with:
          name: docker-images-pr-${{ steps.pr-number.outputs.number }}
          path: /tmp/artifacts
        continue-on-error: true

      - name: Post mirroring confirmation
        if: steps.check-approvals.outputs.approved == 'true' && steps.check-confirmation.outputs.already_posted == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
          ECR_REGISTRY: "123456789012.dkr.ecr.us-east-1.amazonaws.com"
          ECR_PREFIX: "mirror"
        run: |
          PR_NUM="${{ steps.pr-number.outputs.number }}"

          # Try to read images from artifact
          if [[ -f /tmp/artifacts/images.txt ]]; then
            IMAGES=$(cat /tmp/artifacts/images.txt)
            echo "Using images from artifact"
          else
            echo "No artifact found, posting generic confirmation"
            IMAGES=""
          fi

          cat > /tmp/mirror-confirmation.md <<'EOF'
          ## âœ… ECR Mirroring Complete

          All Docker images have been successfully mirrored to ECR:
          EOF

          if [[ -n "$IMAGES" ]]; then
            cat >> /tmp/mirror-confirmation.md <<'EOF'

          | Original Image | ECR Mirror Location |
          |---------------|---------------------|
          EOF

            while IFS= read -r image; do
              if [[ -n "$image" ]]; then
                ECR_IMAGE="${ECR_REGISTRY}/${ECR_PREFIX}/${image}"
                echo "| \`${image}\` | \`${ECR_IMAGE}\` |" >> /tmp/mirror-confirmation.md
              fi
            done <<< "$IMAGES"
          fi

          cat >> /tmp/mirror-confirmation.md <<'EOF'

          ### Status
          - âœ… Mirroring: **COMPLETE**
          - âœ… Images: **Available in ECR**
          - âœ… Ready to merge: **YES**

          ---
          ðŸŽ‰ **This PR is now safe to merge!**

          ðŸ¤– *This is a mock confirmation for testing purposes*
          EOF

          gh pr comment $PR_NUM --body-file /tmp/mirror-confirmation.md
          echo "âœ… Posted mirroring confirmation to PR #$PR_NUM"

      - name: Set status check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUM="${{ steps.pr-number.outputs.number }}"
          HEAD_SHA=$(gh pr view $PR_NUM --json headRefOid --jq '.headRefOid')

          if [[ "${{ steps.check-approvals.outputs.approved }}" == "true" ]]; then
            # Approved - set success status
            gh api "/repos/${{ github.repository }}/statuses/$HEAD_SHA" \
              -f state=success \
              -f context="ECR Mirror Approval" \
              -f description="âœ… Approved for ECR mirroring (1+ reactions)" \
              -f target_url="${{ github.server_url }}/${{ github.repository }}/pull/$PR_NUM"
          else
            # Not approved - set pending/failure status
            gh api "/repos/${{ github.repository }}/statuses/$HEAD_SHA" \
              -f state=pending \
              -f context="ECR Mirror Approval" \
              -f description="â³ Needs 1 +1 reaction to approve ECR mirroring" \
              -f target_url="${{ github.server_url }}/${{ github.repository }}/pull/$PR_NUM"
          fi

          echo "Status check updated for SHA: $HEAD_SHA"
